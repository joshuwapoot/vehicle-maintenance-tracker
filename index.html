<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Maintenance Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen font-sans">

<div class="container mx-auto px-4 py-8 max-w-7xl">
  <!-- Header -->
  <div class="text-center mb-8 relative">
    <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full mb-4 shadow-lg">
      <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
      </svg>
    </div>
    <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3">
      Bristol Maxie 400 Vehicle Maintenance Tracker v61
    </h1>
    <p class="text-xl text-gray-900 max-w-2xl mx-auto">
      Comprehensive maintenance scheduling for optimal vehicle performance and safety
    </p>
  </div>

  <!-- Odometer Input Card -->
  <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border border-gray-100">
    <div class="flex flex-col lg:flex-row items-center justify-center gap-6">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
        <div>
          <label for="odo" class="text-xl font-bold text-gray-800 block">Current Odometer Reading</label>
          <p class="text-gray-500">Enter your vehicle's current mileage</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="relative">
          <input type="number" id="odo" placeholder="e.g. 12000" 
                 class="px-6 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none text-xl w-56 text-center font-mono shadow-sm">
          <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">km</span>
        </div>
        <button onclick="checkMaintenance()" 
                class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
          Analyze Maintenance
        </button>
      </div>
    </div>
  </div>

  <!-- Summary Dashboard -->
  <div id="summaryDashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8 hidden">
    <div onclick="filterItems('all')" class="filter-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-gray-500 cursor-pointer hover:shadow-xl transition-all duration-200 transform hover:-translate-y-1">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">All Items</p>
          <p id="allCount" class="text-3xl font-bold text-gray-600">0</p>
          <p class="text-xs text-gray-500 mt-1">Total items</p>
        </div>
        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">üìã</span>
        </div>
      </div>
    </div>
    
    <div onclick="filterItems('critical')" class="filter-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500 cursor-pointer hover:shadow-xl transition-all duration-200 transform hover:-translate-y-1">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Critical</p>
          <p id="criticalCount" class="text-3xl font-bold text-red-600">0</p>
          <p class="text-xs text-gray-500 mt-1">Items overdue</p>
        </div>
        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">üö®</span>
        </div>
      </div>
    </div>
    
    <div onclick="filterItems('soon')" class="filter-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500 cursor-pointer hover:shadow-xl transition-all duration-200 transform hover:-translate-y-1">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Due Soon</p>
          <p id="soonCount" class="text-3xl font-bold text-yellow-600">0</p>
          <p class="text-xs text-gray-500 mt-1">Within 1000km</p>
        </div>
        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">‚è∞</span>
        </div>
      </div>
    </div>
    
    <div onclick="filterItems('good')" class="filter-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500 cursor-pointer hover:shadow-xl transition-all duration-200 transform hover:-translate-y-1">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Good</p>
          <p id="goodCount" class="text-3xl font-bold text-green-600">0</p>
          <p class="text-xs text-gray-500 mt-1">No action needed</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">‚úÖ</span>
        </div>
      </div>
    </div>
    
    <div onclick="filterItems('predrive')" class="filter-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500 cursor-pointer hover:shadow-xl transition-all duration-200 transform hover:-translate-y-1">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Pre-Drive</p>
          <p id="preDriveCount" class="text-3xl font-bold text-blue-600">0</p>
          <p class="text-xs text-gray-500 mt-1">Check before driving</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">üîç</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div id="navigationTabs" class="bg-white rounded-xl shadow-lg p-2 mb-6 hidden">
    <div class="flex flex-wrap gap-2">
      <button onclick="showTab('schedule')" class="nav-tab active px-6 py-3 rounded-lg font-bold transition-all duration-200">
        üìã Current Schedule
      </button>
      <button onclick="showTab('history')" class="nav-tab px-6 py-3 rounded-lg font-bold transition-all duration-200">
        üìö Service History
      </button>
      <button onclick="showTab('log')" class="nav-tab px-6 py-3 rounded-lg font-bold transition-all duration-200">
        ‚úèÔ∏è Log Service
      </button>
    </div>
  </div>

  <!-- Log Service Form -->
  <div id="logServiceCard" class="bg-white rounded-xl shadow-lg p-8 mb-6 hidden">
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Log Completed Service</h2>
      <p class="text-gray-600">Record maintenance work that has been completed</p>
    </div>
    
    <form id="serviceForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Service Item</label>
          <select id="serviceItem" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
            <option value="">Select maintenance item...</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Odometer Reading (km)</label>
          <input type="number" id="serviceOdometer" placeholder="e.g. 15000" 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Service Date</label>
          <input type="date" id="serviceDate" 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Cost (optional)</label>
          <input type="number" id="serviceCost" placeholder="e.g. 150" step="0.01"
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Notes (optional)</label>
        <textarea id="serviceNotes" rows="3" placeholder="Additional details about the service..."
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none resize-none"></textarea>
      </div>
      
      <div class="flex gap-4">
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-200">
          üíæ Save Service Record
        </button>
        <button type="button" onclick="clearForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-200">
          üóëÔ∏è Clear Form
        </button>
      </div>
    </form>
  </div>

  <!-- Service History -->
  <div id="historyCard" class="bg-white rounded-xl shadow-lg overflow-hidden hidden">
    <div class="px-8 py-6 bg-gradient-to-r from-green-50 to-blue-50 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Service History</h2>
          <p class="text-gray-600 mt-1">Complete record of all maintenance performed</p>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-600">Total Services</p>
          <p id="totalServices" class="text-2xl font-bold text-blue-600">0</p>
        </div>
      </div>
    </div>
    
    <div id="historyContent" class="p-8">
      <div id="historyEmpty" class="text-center py-12">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="text-3xl">üìö</span>
        </div>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Service History Yet</h3>
        <p class="text-gray-500">Start logging your maintenance to build a comprehensive service history</p>
      </div>
      
      <div id="historyList" class="space-y-4 hidden">
        <!-- Service history items will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Maintenance Table -->
  <div id="maintenanceCard" class="bg-white rounded-xl shadow-lg overflow-hidden hidden">
    <div class="px-8 py-6 bg-gradient-to-r from-gray-50 to-blue-50 border-b border-gray-200">
      <h2 class="text-2xl font-bold text-gray-800">Detailed Maintenance Schedule</h2>
      <p class="text-gray-600 mt-1">Complete overview of all maintenance requirements</p>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Component</th>
            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Required Action</th>
            <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">Service Interval</th>
            <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">Next Service</th>
            <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">Priority</th>
          </tr>
        </thead>
        <tbody id="maintenanceTableBody" class="divide-y divide-gray-200">
          <!-- Maintenance items will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Welcome State -->
  <div id="welcomeState" class="text-center py-16">
    <div class="w-32 h-32 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
      </svg>
    </div>
    <h3 class="text-3xl font-bold text-gray-900 mb-4">Ready for Vehicle Analysis</h3>
    <p class="text-xl text-gray-900 max-w-md mx-auto">Enter your current odometer reading to get a comprehensive maintenance report with priority recommendations</p>
  </div>
</div>

<!-- Floating Authentication Box -->
<div id="authBox" class="fixed bottom-6 right-6 z-50 transition-all duration-300 transform">
  <!-- Slide-in Tab -->
  <div id="authTab" class="absolute left-0 top-1/2 transform -translate-y-1/2 -translate-x-full bg-blue-600 text-white px-2 py-3 rounded-l-lg shadow-lg cursor-pointer hover:bg-blue-700 transition-colors" onclick="slideInAuthBox()">
    <div class="flex flex-col items-center">
      <span class="text-xs font-medium writing-mode-vertical transform rotate-180" style="writing-mode: vertical-rl;">Sign In</span>
    </div>
  </div>
  
  <!-- Main Content -->
  <div id="authContent" class="bg-white rounded-xl shadow-2xl border border-gray-200 p-4 max-w-sm">
    <div class="flex items-center space-x-3 mb-3">
      <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </div>
      <div class="flex-1">
        <h3 class="text-sm font-semibold text-gray-900">Sign in with Google</h3>
        <p id="sign-in-status" class="text-xs text-gray-900">Sync your data across devices</p>
      </div>
      <button onclick="slideOutAuthBox()" class="text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <div class="flex space-x-2">
      <button onclick="slideOutAuthBox()" class="flex-1 bg-gray-100 text-gray-900 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
        Stay signed out
      </button>
      <button id="sign-in-btn" onclick="signInWithGoogle()" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
        Sign in
      </button>
    </div>
    
    <!-- Signed in state (hidden by default) -->
    <div id="signedInState" class="hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
            <span class="text-xs">‚úì</span>
          </div>
          <span id="userEmail" class="text-sm text-gray-900"></span>
        </div>
        <button id="sign-out-btn" onclick="signOut()" class="text-xs text-red-600 hover:text-red-700 font-medium">
          Sign out
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBNmYmNM0QKLDa4E8_cmRnoqCaG8uJUe34",
  authDomain: "vehicle-maintenance-474502.firebaseapp.com",
  projectId: "vehicle-maintenance-474502",
  storageBucket: "vehicle-maintenance-474502.firebasestorage.app",
  messagingSenderId: "601538858993",
  appId: "1:601538858993:web:ffe17c13afd579dc6abe50",
  measurementId: "G-BJD27GXM5M",
  databaseURL: "/databases/(default)/documents"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

db.settings({
  host: 'firestore.googleapis.com',
  ssl: true
});

// Global variables
let currentUserId = null;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAINTENANCE ITEMS  (corrected per official Bristol Maxie 400 schedule)
//
//  Codes:
//    I  = Inspect, clean, adjust, lubricate, or replace as needed
//    R  = Replace
//  Intervals are in km.  interval: 0  ‚Üí pre-drive check (every trip).
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const maintenanceItems = [
  // ‚îÄ‚îÄ Fluids & Lubrication ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Oil: R every 2,000 km (break-in at 500 km counts as first change)
  { item: "Lubricating Oil",           action: "Replace",         interval: 2000,  category: "engine" },
  // Oil Filter Screen: I every 2,000 km
  { item: "Oil Filter Screen",         action: "Inspect",         interval: 2000,  category: "engine" },
  // Gear Oil: R at 2k, then R every 10,000 km
  { item: "Gear Oil",                  action: "Replace",         interval: 10000, category: "transmission" },
  // Brake Fluid: I every 6k (calendar replace every 2 years)
  { item: "Brake Fluid",               action: "Inspect",         interval: 6000,  category: "brake" },
  // Coolant: I every 2k (calendar replace every 3 years)
  { item: "Coolant",                   action: "Inspect",         interval: 2000,  category: "cooling" },

  // ‚îÄ‚îÄ Engine & Fuel System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Spark Plug: I at 6k; R at 12k, 24k, 36k  ‚Üí base interval 6k
  { item: "Spark Plug",                action: "Inspect/Replace", interval: 6000,  category: "engine" },
  // Air Filter / CVT Sponge: I every 2k, R every 10k
  { item: "Air Filter / CVT Sponge",   action: "Inspect",         interval: 2000,  category: "engine" },
  // Valve Clearance: I every 6k
  { item: "Valve Clearance",           action: "Inspect",         interval: 6000,  category: "engine" },
  // Engine Fine Filter: I at 12k, 24k, 36k  ‚Üí interval 12k
  { item: "Engine Fine Filter",        action: "Inspect",         interval: 12000, category: "engine" },
  // Fuel Line & Throttle: I every 6k
  { item: "Fuel Line",                 action: "Inspect",         interval: 6000,  category: "fuel" },
  { item: "Throttle Operation",        action: "Inspect",         interval: 6000,  category: "engine" },
  // Crankcase Breather: I every 6k
  { item: "Crankcase Breather",        action: "Inspect",         interval: 6000,  category: "engine" },

  // ‚îÄ‚îÄ Drive Train & Braking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Drive Belt: I at 12k; R at 24k  ‚Üí base interval 12k
  { item: "Drive Belt",                action: "Inspect/Replace", interval: 12000, category: "engine" },
  // Belt Chamber / Pulley: I every 4k
  { item: "Belt Chamber / Belt Pulley",action: "Inspect",         interval: 4000,  category: "engine" },
  // Brake System & Pads: I every 6k (also a pre-drive check)
  { item: "Brake System & Pads",       action: "Inspect",         interval: 6000,  category: "brake" },
  // Worn Clutch Shoe: I at 12k, 24k, 36k  ‚Üí interval 12k
  { item: "Clutch Shoe",               action: "Inspect",         interval: 12000, category: "transmission" },

  // ‚îÄ‚îÄ Chassis & Electrical ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { item: "Suspension",                action: "Inspect",         interval: 6000,  category: "chassis" },
  // Steering Column Bearing: I at 12k, 24k, 36k  ‚Üí interval 12k
  { item: "Steering Column Bearing",   action: "Inspect",         interval: 12000, category: "steering" },
  // Battery: I at 0.5k, then every 4k
  { item: "Battery",                   action: "Inspect",         interval: 4000,  category: "electrical" },
  // Nuts, Bolts, Fasteners: I at 0.5k and every 6k
  { item: "Nuts, Bolts, Fasteners",    action: "Inspect",         interval: 6000,  category: "general" },
  // Wheels & Tires: I every 6k (also a pre-drive check)
  { item: "Wheels & Tires",            action: "Inspect",         interval: 6000,  category: "chassis" },
  { item: "Headlamp Beam",             action: "Inspect",         interval: 6000,  category: "electrical" },
  { item: "Lamp and Horn",             action: "Inspect",         interval: 6000,  category: "electrical" },

  // ‚îÄ‚îÄ Pre-Drive Checks (every trip ‚Äî interval: 0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { item: "Fuel Quantity",             action: "Inspect",         interval: 0,     category: "fuel" },
  { item: "Brake System (Pre-Drive)",  action: "Inspect",         interval: 0,     category: "brake" },
  { item: "Tires (Pre-Drive)",         action: "Inspect",         interval: 0,     category: "chassis" }
];

let currentFilter = 'all';
let maintenanceData = [];
let currentTab = 'schedule';
let serviceHistory = [];

// Listen for authentication state changes
auth.onAuthStateChanged((user) => {
  const authBox = document.getElementById('authBox');
  const signedInState = document.getElementById('signedInState');
  const signInButtons = authBox.querySelector('.flex.space-x-2');
  const authTab = document.getElementById('authTab');
  const tabText = authTab.querySelector('span');
  
  if (user) {
    currentUserId = user.uid;
    document.getElementById('userEmail').textContent = user.email;
    signInButtons.classList.add('hidden');
    signedInState.classList.remove('hidden');
    tabText.textContent = 'Signed In';
    authTab.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    authTab.classList.add('bg-green-600', 'hover:bg-green-700');
    loadServiceHistory();
    setTimeout(() => { slideOutAuthBox(); }, 2000);
  } else {
    currentUserId = null;
    signInButtons.classList.remove('hidden');
    signedInState.classList.add('hidden');
    tabText.textContent = 'Sign In';
    authTab.classList.remove('bg-green-600', 'hover:bg-green-700');
    authTab.classList.add('bg-blue-600', 'hover:bg-blue-700');
    loadServiceHistoryLocal();
  }
});

function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then((result) => {
      showSuccessMessage(`Welcome ${result.user.displayName}!`);
    })
    .catch((error) => {
      console.error("Firebase Sign-in error:", error);
      showErrorMessage('Sign-in failed. Please try again.');
    });
}

function signOut() {
  auth.signOut()
    .then(() => {
      showSuccessMessage('Signed out successfully');
      setTimeout(() => { window.location.reload(); }, 1500);
    })
    .catch((error) => {
      console.error('Sign-out error:', error);
      showErrorMessage('Sign-out failed. Please try again.');
    });
}

function slideOutAuthBox() {
  document.getElementById('authBox').classList.add('translate-x-full');
}

function slideInAuthBox() {
  document.getElementById('authBox').classList.remove('translate-x-full');
}

function getMaintenanceStatus(currentKm, interval, lastServiceKm = 0) {
  if (interval === 0) {
    return { status: 'predrive', label: 'Pre-Drive Check', class: 'bg-blue-100 text-blue-800', priority: 3 };
  }
  const nextDue = lastServiceKm + interval;
  const kmUntilDue = nextDue - currentKm;
  if (kmUntilDue <= 0) {
    return { status: 'critical', label: 'Overdue', class: 'bg-red-100 text-red-800', priority: 1 };
  } else if (kmUntilDue <= 1000) {
    return { status: 'soon', label: 'Due Soon', class: 'bg-yellow-100 text-yellow-800', priority: 2 };
  } else {
    return { status: 'good', label: 'Good', class: 'bg-green-100 text-green-800', priority: 4 };
  }
}

function showTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.nav-tab').forEach(btn => {
    btn.classList.remove('active', 'bg-blue-600', 'text-white');
    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
  });
  if (event && event.target) {
    event.target.classList.add('active', 'bg-blue-600', 'text-white');
    event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
  }
  document.getElementById('maintenanceCard').classList.add('hidden');
  document.getElementById('historyCard').classList.add('hidden');
  document.getElementById('logServiceCard').classList.add('hidden');
  if (tab === 'schedule') {
    document.getElementById('maintenanceCard').classList.remove('hidden');
  } else if (tab === 'history') {
    document.getElementById('historyCard').classList.remove('hidden');
    if (serviceHistory.length === 0) loadServiceHistoryLocal();
    renderHistory();
  } else if (tab === 'log') {
    document.getElementById('logServiceCard').classList.remove('hidden');
    populateServiceItems();
  }
}

function getLastServiceKm(itemName) {
  const services = serviceHistory.filter(s => s.item === itemName);
  if (services.length === 0) return 0;
  return Math.max(...services.map(s => s.odometer));
}

async function loadServiceHistory() {
  if (!currentUserId) return loadServiceHistoryLocal();
  await new Promise(resolve => setTimeout(resolve, 1000));
  if (!auth.currentUser) return loadServiceHistoryLocal();
  try {
    const user = auth.currentUser;
    await user.getIdToken(true);
    const snapshot = await db.collection('serviceHistory')
      .where('userId', '==', currentUserId)
      .orderBy('timestamp', 'desc')
      .get();
    serviceHistory = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.createdAt && data.createdAt.toDate) data.createdAt = data.createdAt.toDate().toISOString();
      if (data.updatedAt && data.updatedAt.toDate) data.updatedAt = data.updatedAt.toDate().toISOString();
      serviceHistory.push({ id: doc.id, ...data });
    });
    localStorage.setItem(getStorageKey(), JSON.stringify(serviceHistory));
    showSuccessMessage(`Synced ${serviceHistory.length} records from Firebase!`);
    return serviceHistory;
  } catch (error) {
    console.error('Firebase load error:', error);
    showErrorMessage('Firebase connection failed. Using local storage mode.');
    return loadServiceHistoryLocal();
  }
}

function loadServiceHistoryLocal() {
  const stored = localStorage.getItem(getStorageKey());
  serviceHistory = stored ? JSON.parse(stored) : [];
  return serviceHistory;
}

function getStorageKey() {
  return currentUserId ? `vehicleServiceHistory_${currentUserId}` : 'vehicleServiceHistory_guest';
}

async function saveServiceRecord(serviceRecord) {
  serviceHistory.push(serviceRecord);
  localStorage.setItem(getStorageKey(), JSON.stringify(serviceHistory));
  if (!currentUserId || !auth.currentUser) return serviceRecord;
  try {
    const user = auth.currentUser;
    await user.getIdToken(true);
    const recordWithUserId = {
      ...serviceRecord,
      userId: currentUserId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    const docRef = await db.collection('serviceHistory').add(recordWithUserId);
    const idx = serviceHistory.findIndex(r => r.id === serviceRecord.id);
    if (idx !== -1) {
      serviceHistory[idx].firebaseId = docRef.id;
      localStorage.setItem(getStorageKey(), JSON.stringify(serviceHistory));
    }
  } catch (error) {
    console.error('Firebase save failed:', error);
  }
  return serviceRecord;
}

async function logService(event) {
  event.preventDefault();
  const item = document.getElementById('serviceItem').value;
  const odometerValue = document.getElementById('serviceOdometer').value;
  const date = document.getElementById('serviceDate').value;
  const costValue = document.getElementById('serviceCost').value;
  const notes = document.getElementById('serviceNotes').value;
  if (!item || !odometerValue || !date) {
    showErrorMessage('Please fill in all required fields (Service Item, Odometer, Date)');
    return;
  }
  const odometer = parseInt(odometerValue);
  const cost = parseFloat(costValue) || 0;
  if (isNaN(odometer) || odometer <= 0) {
    showErrorMessage('Please enter a valid odometer reading');
    return;
  }
  const serviceRecord = {
    id: Date.now() + Math.random(),
    item, odometer, date, cost,
    notes: notes.trim(),
    timestamp: new Date().toISOString()
  };
  try {
    await saveServiceRecord(serviceRecord);
    clearForm();
    if (currentTab === 'history') renderHistory();
    showSuccessMessage('Service record saved successfully!');
  } catch (error) {
    showErrorMessage('Failed to save service record. Please try again.');
  }
}

function clearForm() {
  document.getElementById('serviceForm').reset();
  document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
}

function populateServiceItems() {
  const select = document.getElementById('serviceItem');
  select.innerHTML = '<option value="">Select maintenance item...</option>';
  maintenanceItems.forEach(item => {
    const option = document.createElement('option');
    option.value = item.item;
    option.textContent = item.item;
    select.appendChild(option);
  });
}

function renderHistory() {
  const historyList = document.getElementById('historyList');
  const historyEmpty = document.getElementById('historyEmpty');
  document.getElementById('totalServices').textContent = serviceHistory.length;
  if (serviceHistory.length === 0) {
    historyEmpty.classList.remove('hidden');
    historyList.classList.add('hidden');
    return;
  }
  historyEmpty.classList.add('hidden');
  historyList.classList.remove('hidden');
  const sortedHistory = [...serviceHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
  historyList.innerHTML = '';
  sortedHistory.forEach(service => {
    const serviceCard = document.createElement('div');
    serviceCard.className = 'bg-gray-50 rounded-lg p-6 border-l-4 border-blue-500';
    const categoryIcon = getCategoryIcon(maintenanceItems.find(i => i.item === service.item)?.category || 'general');
    const costDisplay = service.cost > 0 ? `<span class="text-green-600 font-semibold">$${service.cost.toFixed(2)}</span>` : '<span class="text-gray-400">No cost recorded</span>';
    serviceCard.innerHTML = `
      <div class="flex justify-between items-start mb-3">
        <div class="flex items-center">
          <span class="text-2xl mr-3">${categoryIcon}</span>
          <div>
            <h3 class="font-bold text-gray-800">${service.item}</h3>
            <p class="text-sm text-gray-600">${new Date(service.date).toLocaleDateString()}</p>
          </div>
        </div>
        <div class="text-right">
          <p class="font-mono text-lg font-semibold text-gray-800">${service.odometer.toLocaleString()} km</p>
          <p class="text-sm">${costDisplay}</p>
        </div>
      </div>
      ${service.notes ? `<div class="bg-white rounded p-3 text-sm text-gray-700"><strong>Notes:</strong> ${service.notes}</div>` : ''}
      <div class="flex justify-end mt-3">
        <button onclick="deleteService(${service.id})" class="text-red-500 hover:text-red-700 text-sm font-medium">üóëÔ∏è Delete Record</button>
      </div>`;
    historyList.appendChild(serviceCard);
  });
}

async function deleteService(serviceId) {
  if (!confirm('Are you sure you want to delete this service record?')) return;
  try {
    const record = serviceHistory.find(s => s.id === serviceId);
    if (currentUserId && auth.currentUser && record && record.firebaseId) {
      await auth.currentUser.getIdToken(true);
      await db.collection('serviceHistory').doc(record.firebaseId).delete();
    }
    serviceHistory = serviceHistory.filter(s => s.id !== serviceId);
    localStorage.setItem(getStorageKey(), JSON.stringify(serviceHistory));
    showSuccessMessage('Service record deleted successfully!');
    renderHistory();
  } catch (error) {
    serviceHistory = serviceHistory.filter(s => s.id !== serviceId);
    localStorage.setItem(getStorageKey(), JSON.stringify(serviceHistory));
    showSuccessMessage('Service record deleted locally!');
    renderHistory();
  }
}

function getCategoryIcon(category) {
  const icons = {
    engine: "üîß", brake: "üõë", electrical: "‚ö°", fuel: "‚õΩ",
    transmission: "‚öôÔ∏è", cooling: "‚ùÑÔ∏è", chassis: "üöó", steering: "üéØ", general: "üî©"
  };
  return icons[category] || "üîß";
}

function checkMaintenance() {
  const odo = parseInt(document.getElementById("odo").value);
  if (!odo || odo <= 0) { alert("Please enter a valid odometer reading"); return; }

  maintenanceData = [];
  let criticalCount = 0, soonCount = 0, goodCount = 0, preDriveCount = 0;

  maintenanceItems.forEach(item => {
    const lastServiceKm = getLastServiceKm(item.item);
    const nextDue = item.interval === 0 ? 0 : lastServiceKm + item.interval;
    const kmUntilDue = item.interval === 0 ? 0 : nextDue - odo;
    const statusInfo = getMaintenanceStatus(odo, item.interval, lastServiceKm);
    maintenanceData.push({
      ...item, nextDue, kmUntilDue, statusInfo, lastServiceKm,
      lastServiceDate: getLastServiceDate(item.item)
    });
    if (statusInfo.status === 'critical') criticalCount++;
    else if (statusInfo.status === 'soon') soonCount++;
    else if (statusInfo.status === 'good') goodCount++;
    else if (statusInfo.status === 'predrive') preDriveCount++;
  });

  maintenanceData.sort((a, b) => {
    if (a.statusInfo.priority !== b.statusInfo.priority) return a.statusInfo.priority - b.statusInfo.priority;
    if (a.interval === 0 && b.interval === 0) return 0;
    if (a.interval === 0) return 1;
    if (b.interval === 0) return -1;
    return a.kmUntilDue - b.kmUntilDue;
  });

  document.getElementById("allCount").textContent = maintenanceData.length;
  document.getElementById("criticalCount").textContent = criticalCount;
  document.getElementById("soonCount").textContent = soonCount;
  document.getElementById("goodCount").textContent = goodCount;
  document.getElementById("preDriveCount").textContent = preDriveCount;

  document.getElementById("summaryDashboard").classList.remove("hidden");
  document.getElementById("navigationTabs").classList.remove("hidden");
  document.getElementById("maintenanceCard").classList.remove("hidden");
  document.getElementById("welcomeState").classList.add("hidden");
  renderTable();
}

function getLastServiceDate(itemName) {
  const services = serviceHistory.filter(s => s.item === itemName);
  if (services.length === 0) return null;
  return services.reduce((latest, s) => new Date(s.date) > new Date(latest.date) ? s : latest).date;
}

function renderTable() {
  const tbody = document.getElementById("maintenanceTableBody");
  const filteredData = currentFilter === 'all' ? maintenanceData :
                       maintenanceData.filter(item => item.statusInfo.status === currentFilter);

  const existingRows = tbody.querySelectorAll('tr');
  if (existingRows.length > 0) {
    existingRows.forEach((row, index) => {
      setTimeout(() => { row.style.transform = 'translateX(-100%)'; row.style.opacity = '0'; }, index * 50);
    });
    setTimeout(() => { tbody.innerHTML = ""; addNewRows(); }, existingRows.length * 50 + 300);
  } else {
    addNewRows();
  }

  function addNewRows() {
    if (filteredData.length === 0) {
      const emptyRow = document.createElement("tr");
      emptyRow.className = "transition-all duration-500";
      emptyRow.style.transform = 'translateY(20px)';
      emptyRow.style.opacity = '0';
      emptyRow.innerHTML = `
        <td colspan="5" class="px-6 py-16 text-center">
          <div class="flex flex-col items-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"><span class="text-2xl">üìã</span></div>
            <h3 class="text-lg font-semibold text-gray-600 mb-2">No items in this category</h3>
            <p class="text-gray-500">Try selecting a different filter or check your maintenance data</p>
          </div>
        </td>`;
      tbody.appendChild(emptyRow);
      setTimeout(() => { emptyRow.style.transform = 'translateY(0)'; emptyRow.style.opacity = '1'; }, 100);
      return;
    }

    filteredData.forEach((item, index) => {
      const row = document.createElement("tr");
      row.className = "hover:bg-gray-50 transition-all duration-300";
      row.style.transform = 'translateX(100%)';
      row.style.opacity = '0';

      const nextDueDisplay = item.interval === 0 ?
        '<span class="text-blue-600 font-semibold">Every Drive</span>' :
        `<span class="font-mono text-gray-900">${item.nextDue.toLocaleString()}</span>
         <div class="text-sm text-gray-500">${item.kmUntilDue > 0 ? `in ${item.kmUntilDue.toLocaleString()} km` : 'overdue'}</div>`;

      const lastServiceDisplay = item.lastServiceKm > 0 ?
        `<div class="text-xs text-green-600 mt-1">Last: ${item.lastServiceKm.toLocaleString()} km</div>` :
        '<div class="text-xs text-gray-400 mt-1">Never serviced</div>';

      row.innerHTML = `
        <td class="px-6 py-4">
          <div class="flex items-center">
            <span class="text-2xl mr-3">${getCategoryIcon(item.category)}</span>
            <div>
              <span class="font-semibold text-gray-900">${item.item}</span>
              <div class="text-sm text-gray-500 capitalize">${item.category}</div>
              ${lastServiceDisplay}
            </div>
          </div>
        </td>
        <td class="px-6 py-4"><span class="font-medium text-gray-700">${item.action}</span></td>
        <td class="px-6 py-4 text-center">
          <span class="font-mono text-gray-600">${item.interval === 0 ? 'Pre-Drive' : item.interval.toLocaleString() + ' km'}</span>
        </td>
        <td class="px-6 py-4 text-center">${nextDueDisplay}</td>
        <td class="px-6 py-4 text-center">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${item.statusInfo.class}">${item.statusInfo.label}</span>
        </td>`;

      tbody.appendChild(row);
      setTimeout(() => { row.style.transform = 'translateX(0)'; row.style.opacity = '1'; }, index * 100 + 50);
    });
  }
}

function filterItems(filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-card').forEach(card => {
    card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
    card.classList.add('bg-white');
  });
  const activeCard = event ? event.currentTarget : document.querySelector(`[onclick="filterItems('${filter}')"]`);
  if (activeCard) {
    activeCard.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
    activeCard.classList.remove('bg-white');
  }
  const maintenanceCard = document.getElementById('maintenanceCard');
  if (maintenanceCard && !maintenanceCard.classList.contains('hidden')) {
    maintenanceCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  renderTable();
}

function showSuccessMessage(message) { showToast(message, 'success'); }
function showErrorMessage(message) { showToast(message, 'error'); }

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-full`;
  if (type === 'success') {
    toast.classList.add('bg-green-600');
    toast.innerHTML = `<div class="flex items-center"><span class="mr-2">‚úÖ</span>${message}</div>`;
  } else if (type === 'error') {
    toast.classList.add('bg-red-600');
    toast.innerHTML = `<div class="flex items-center"><span class="mr-2">‚ùå</span>${message}</div>`;
  } else {
    toast.classList.add('bg-blue-600');
    toast.innerHTML = `<div class="flex items-center"><span class="mr-2">‚ÑπÔ∏è</span>${message}</div>`;
  }
  document.body.appendChild(toast);
  setTimeout(() => { toast.classList.remove('translate-x-full'); }, 100);
  setTimeout(() => {
    toast.classList.add('translate-x-full');
    setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
  }, 4000);
}

document.addEventListener('DOMContentLoaded', function() {
  loadServiceHistoryLocal();
  document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('serviceForm').addEventListener('submit', logService);
  const activeTab = document.querySelector('.nav-tab.active');
  if (activeTab) {
    activeTab.classList.add('bg-blue-600', 'text-white');
    activeTab.classList.remove('text-gray-600', 'hover:bg-gray-100');
  }
  document.querySelectorAll('.nav-tab:not(.active)').forEach(btn => {
    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
  });
  setTimeout(() => {
    const allItemsCard = document.querySelector(`[onclick="filterItems('all')"]`);
    if (allItemsCard) {
      allItemsCard.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
      allItemsCard.classList.remove('bg-white');
    }
  }, 100);
});

document.getElementById("odo").addEventListener("keypress", function(event) {
  if (event.key === "Enter") checkMaintenance();
});
</script>
</body>
</html>
