<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Maintenance Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen font-sans">

<div class="container mx-auto px-4 py-8 max-w-7xl">
  <!-- Header -->
  <div class="text-center mb-8">
    <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full mb-4 shadow-lg">
      <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
      </svg>
    </div>
    <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3">
      Vehicle Maintenance Tracker v4 343
    </h1>
    <p class="text-xl text-gray-600 max-w-2xl mx-auto">
      Comprehensive maintenance scheduling for optimal vehicle performance and safety
    </p>
    
    <!-- Firebase Authentication Status -->
    <div class="mt-4 max-w-2xl mx-auto bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex items-start space-x-3">
        <div class="flex-shrink-0">
          <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="text-sm font-semibold text-blue-800 mb-1">üîê Firebase Authentication</h3>
          <p id="sign-in-status" class="text-sm text-blue-700 mb-2">
            Signed out - Sign in to sync your data across devices
          </p>
          <div class="flex space-x-2">
            <button id="sign-in-btn" onclick="signInWithGoogle()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium hover:bg-blue-700">
              Sign In with Google
            </button>
            <button id="sign-out-btn" onclick="signOut()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm font-medium hover:bg-gray-600 hidden">
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Odometer Input Card -->
  <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border border-gray-100">
    <div class="flex flex-col lg:flex-row items-center justify-center gap-6">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
        <div>
          <label for="odo" class="text-xl font-bold text-gray-800 block">Current Odometer Reading</label>
          <p class="text-gray-500">Enter your vehicle's current mileage</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="relative">
          <input type="number" id="odo" placeholder="e.g. 12000" 
                 class="px-6 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none text-xl w-56 text-center font-mono shadow-sm">
          <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-semibold">km</span>
        </div>
        <button onclick="checkMaintenance()" 
                class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
          Analyze Maintenance
        </button>
      </div>
    </div>
  </div>

  <!-- Summary Dashboard -->
  <div id="summaryDashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Critical</p>
          <p id="criticalCount" class="text-3xl font-bold text-red-600">0</p>
          <p class="text-xs text-gray-500 mt-1">Items overdue</p>
        </div>
        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">üö®</span>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Due Soon</p>
          <p id="soonCount" class="text-3xl font-bold text-yellow-600">0</p>
          <p class="text-xs text-gray-500 mt-1">Within 1000km</p>
        </div>
        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">‚è∞</span>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Good</p>
          <p id="goodCount" class="text-3xl font-bold text-green-600">0</p>
          <p class="text-xs text-gray-500 mt-1">No action needed</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">‚úÖ</span>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Pre-Drive</p>
          <p id="preDriveCount" class="text-3xl font-bold text-blue-600">0</p>
          <p class="text-xs text-gray-500 mt-1">Check before driving</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
          <span class="text-2xl">üîç</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div id="filterTabs" class="bg-white rounded-xl shadow-lg p-2 mb-6 hidden">
    <div class="flex flex-wrap gap-2">
      <button onclick="filterItems('all')" class="filter-btn active px-4 py-2 rounded-lg font-semibold transition-all duration-200">
        All Items
      </button>
      <button onclick="filterItems('critical')" class="filter-btn px-4 py-2 rounded-lg font-semibold transition-all duration-200">
        Critical
      </button>
      <button onclick="filterItems('soon')" class="filter-btn px-4 py-2 rounded-lg font-semibold transition-all duration-200">
        Due Soon
      </button>
      <button onclick="filterItems('good')" class="filter-btn px-4 py-2 rounded-lg font-semibold transition-all duration-200">
        Good
      </button>
      <button onclick="filterItems('predrive')" class="filter-btn px-4 py-2 rounded-lg font-semibold transition-all duration-200">
        Pre-Drive
      </button>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div id="navigationTabs" class="bg-white rounded-xl shadow-lg p-2 mb-6 hidden">
    <div class="flex flex-wrap gap-2">
      <button onclick="showTab('schedule')" class="nav-tab active px-6 py-3 rounded-lg font-bold transition-all duration-200">
        üìã Current Schedule
      </button>
      <button onclick="showTab('history')" class="nav-tab px-6 py-3 rounded-lg font-bold transition-all duration-200">
        üìö Service History
      </button>
      <button onclick="showTab('log')" class="nav-tab px-6 py-3 rounded-lg font-bold transition-all duration-200">
        ‚úèÔ∏è Log Service
      </button>
    </div>
  </div>

  <!-- Log Service Form -->
  <div id="logServiceCard" class="bg-white rounded-xl shadow-lg p-8 mb-6 hidden">
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Log Completed Service</h2>
      <p class="text-gray-600">Record maintenance work that has been completed</p>
    </div>
    
    <form id="serviceForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Service Item</label>
          <select id="serviceItem" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
            <option value="">Select maintenance item...</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Odometer Reading (km)</label>
          <input type="number" id="serviceOdometer" placeholder="e.g. 15000" 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Service Date</label>
          <input type="date" id="serviceDate" 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Cost (optional)</label>
          <input type="number" id="serviceCost" placeholder="e.g. 150" step="0.01"
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Notes (optional)</label>
        <textarea id="serviceNotes" rows="3" placeholder="Additional details about the service..."
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none resize-none"></textarea>
      </div>
      
      <div class="flex gap-4">
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-200">
          üíæ Save Service Record
        </button>
        <button type="button" onclick="clearForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-200">
          üóëÔ∏è Clear Form
        </button>
      </div>
    </form>
  </div>

  <!-- Service History -->
  <div id="historyCard" class="bg-white rounded-xl shadow-lg overflow-hidden hidden">
    <div class="px-8 py-6 bg-gradient-to-r from-green-50 to-blue-50 border-b">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Service History</h2>
          <p class="text-gray-600 mt-1">Complete record of all maintenance performed</p>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-600">Total Services</p>
          <p id="totalServices" class="text-2xl font-bold text-blue-600">0</p>
        </div>
      </div>
    </div>
    
    <div id="historyContent" class="p-8">
      <div id="historyEmpty" class="text-center py-12">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="text-3xl">üìö</span>
        </div>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Service History Yet</h3>
        <p class="text-gray-500">Start logging your maintenance to build a comprehensive service history</p>
      </div>
      
      <div id="historyList" class="space-y-4 hidden">
        <!-- Service history items will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Maintenance Table -->
  <div id="maintenanceCard" class="bg-white rounded-xl shadow-lg overflow-hidden hidden">
    <div class="px-8 py-6 bg-gradient-to-r from-gray-50 to-blue-50 border-b">
      <h2 class="text-2xl font-bold text-gray-800">Detailed Maintenance Schedule</h2>
      <p class="text-gray-600 mt-1">Complete overview of all maintenance requirements</p>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Component</th>
            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Required Action</th>
            <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">Service Interval</th>
            <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">Next Service</th>
            <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider">Priority</th>
          </tr>
        </thead>
        <tbody id="maintenanceTableBody" class="divide-y divide-gray-200">
          <!-- Maintenance items will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Welcome State -->
  <div id="welcomeState" class="text-center py-16">
    <div class="w-32 h-32 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
      </svg>
    </div>
    <h3 class="text-3xl font-bold text-gray-700 mb-4">Ready for Vehicle Analysis</h3>
    <p class="text-xl text-gray-500 max-w-md mx-auto">Enter your current odometer reading to get a comprehensive maintenance report with priority recommendations</p>
  </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBNmYmNM0QKLDa4E8_cmRnoqCaG8uJUe34",
  authDomain: "vehicle-maintenance-474502.firebaseapp.com",
  projectId: "vehicle-maintenance-474502",
  storageBucket: "vehicle-maintenance-474502.firebasestorage.app",
  messagingSenderId: "601538858993",
  appId: "1:601538858993:web:ffe17c13afd579dc6abe50",
  measurementId: "G-BJD27GXM5M"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Global variables
let currentUserId = null;

const maintenanceItems = [
  { item: "Battery", action: "Charge", interval: 4000, category: "electrical" },
  { item: "Brake Fluid", action: "Replace", interval: 20000, category: "brake" },
  { item: "Lubricating Oil", action: "Replace", interval: 2000, category: "engine" },
  { item: "Lubricating Oil Filter", action: "Replace", interval: 2000, category: "engine" },
  { item: "Gear Oil", action: "Replace", interval: 6000, category: "transmission" },
  { item: "Crankcase Breather Pipe", action: "Replace", interval: 10000, category: "engine" },
  { item: "Engine Fine Filter", action: "Replace", interval: 12000, category: "engine" },
  { item: "Fuel Line", action: "Inspect", interval: 2000, category: "fuel" },
  { item: "Fuel Quantity", action: "Inspect", interval: 0, category: "fuel" },
  { item: "Throttle Operation", action: "Inspect", interval: 2000, category: "engine" },
  { item: "Fuel Evaporation Control System", action: "Inspect", interval: 2000, category: "fuel" },
  { item: "Fuel Tank & Charcoal Canister", action: "Inspect", interval: 2000, category: "fuel" },
  { item: "Drive Belt", action: "Inspect", interval: 4000, category: "engine" },
  { item: "Belt Chamber / Belt Pulley", action: "Inspect", interval: 12000, category: "engine" },
  { item: "Valve Clearance", action: "Inspect", interval: 12000, category: "engine" },
  { item: "Spark Plug", action: "Inspect/Replace", interval: 12000, category: "engine" },
  { item: "Brake Pad Wear", action: "Inspect", interval: 6000, category: "brake" },
  { item: "Coolant", action: "Replace", interval: 10000, category: "cooling" },
  { item: "Engine Idling", action: "Inspect", interval: 6000, category: "engine" },
  { item: "Clutch Shoe Block", action: "Inspect", interval: 6000, category: "transmission" },
  { item: "Brake System", action: "Inspect", interval: 6000, category: "brake" },
  { item: "Headlamp Beam", action: "Inspect", interval: 6000, category: "electrical" },
  { item: "Lamp and Horn", action: "Inspect", interval: 6000, category: "electrical" },
  { item: "Side/Main Bracket", action: "Inspect", interval: 6000, category: "chassis" },
  { item: "Suspension", action: "Inspect", interval: 6000, category: "chassis" },
  { item: "Steering Column Bearing", action: "Inspect", interval: 6000, category: "steering" },
  { item: "Wheels & Tires", action: "Inspect", interval: 6000, category: "chassis" },
  { item: "Nuts, Bolts, Fasteners", action: "Inspect", interval: 6000, category: "general" }
];

let currentFilter = 'all';
let maintenanceData = [];
let currentTab = 'schedule';
let serviceHistory = [];

// Listen for authentication state changes
auth.onAuthStateChanged((user) => {
  if (user) {
    currentUserId = user.uid;
    document.getElementById('sign-in-status').textContent = `Signed in as: ${user.email}`;
    document.getElementById('sign-in-btn').classList.add('hidden');
    document.getElementById('sign-out-btn').classList.remove('hidden');
    // Automatically load the user's logs when signed in
    loadServiceHistory();
  } else {
    currentUserId = null;
    document.getElementById('sign-in-status').textContent = 'Signed out - Sign in to sync your data across devices';
    document.getElementById('sign-in-btn').classList.remove('hidden');
    document.getElementById('sign-out-btn').classList.add('hidden');
    // Load from localStorage when signed out
    loadServiceHistoryLocal();
  }
});

// --- Function to trigger Google Sign-In ---
function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  // Request Google sign-in using a pop-up
  auth.signInWithPopup(provider)
    .then((result) => {
      // The onAuthStateChanged listener handles successful sign-in
      showSuccessMessage(`Welcome ${result.user.displayName}!`);
      console.log("Firebase Sign-in successful:", result.user.email);
    })
    .catch((error) => {
      console.error("Firebase Sign-in error:", error);
      showErrorMessage('Sign-in failed. Please try again.');
    });
}

function signOut() {
  auth.signOut()
    .then(() => {
      showSuccessMessage('Signed out successfully');
    })
    .catch((error) => {
      console.error('Sign-out error:', error);
      showErrorMessage('Sign-out failed. Please try again.');
    });
}

function getNextDueKm(currentKm, interval) {
  if (interval === 0) return 0;
  return Math.ceil(currentKm / interval) * interval;
}

function getMaintenanceStatus(currentKm, interval, lastServiceKm = 0) {
  if (interval === 0) {
    return { status: 'predrive', label: 'Pre-Drive Check', class: 'bg-blue-100 text-blue-800', priority: 3 };
  }
  
  // Calculate next due based on actual last service
  const nextDue = lastServiceKm + interval;
  const kmUntilDue = nextDue - currentKm;
  
  if (kmUntilDue <= 0) {
    return { status: 'critical', label: 'Overdue', class: 'bg-red-100 text-red-800', priority: 1 };
  } else if (kmUntilDue <= 1000) {
    return { status: 'soon', label: 'Due Soon', class: 'bg-yellow-100 text-yellow-800', priority: 2 };
  } else {
    return { status: 'good', label: 'Good', class: 'bg-green-100 text-green-800', priority: 4 };
  }
}

function showTab(tab) {
  currentTab = tab;
  
  // Update active tab
  document.querySelectorAll('.nav-tab').forEach(btn => {
    btn.classList.remove('active', 'bg-blue-600', 'text-white');
    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
  });
  
  event.target.classList.add('active', 'bg-blue-600', 'text-white');
  event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
  
  // Show/hide content
  document.getElementById('maintenanceCard').classList.add('hidden');
  document.getElementById('historyCard').classList.add('hidden');
  document.getElementById('logServiceCard').classList.add('hidden');
  document.getElementById('filterTabs').classList.add('hidden');
  
  if (tab === 'schedule') {
    document.getElementById('maintenanceCard').classList.remove('hidden');
    document.getElementById('filterTabs').classList.remove('hidden');
  } else if (tab === 'history') {
    document.getElementById('historyCard').classList.remove('hidden');
    renderHistory();
  } else if (tab === 'log') {
    document.getElementById('logServiceCard').classList.remove('hidden');
    populateServiceItems();
  }
}

function getLastServiceKm(itemName) {
  const services = serviceHistory.filter(service => service.item === itemName);
  if (services.length === 0) return 0;
  return Math.max(...services.map(service => service.odometer));
}

// --- Function to load the user's service history from Firestore ---
async function loadServiceHistory() {
  if (!currentUserId) {
    return loadServiceHistoryLocal(); // Load from localStorage when not signed in
  }

  const userId = currentUserId;
  
  try {
    const snapshot = await db.collection('users').doc(userId).collection('serviceHistory').orderBy('timestamp', 'desc').get();
    serviceHistory = [];
    
    snapshot.forEach(doc => {
      serviceHistory.push({ id: doc.id, ...doc.data() });
    });
    
    // Also save to localStorage as backup
    localStorage.setItem('vehicleServiceHistory', JSON.stringify(serviceHistory));
    
    console.log(`Logs loaded successfully from Firebase: ${serviceHistory.length} records`);
    return serviceHistory;
  } catch (error) {
    console.error('Firestore Load Failed:', error);
    showErrorMessage('Failed to load data from Firebase. Using local storage.');
    return loadServiceHistoryLocal();
  }
}

// Load service history from localStorage (fallback)
function loadServiceHistoryLocal() {
  const stored = localStorage.getItem('vehicleServiceHistory');
  serviceHistory = stored ? JSON.parse(stored) : [];
  console.log(`Loaded ${serviceHistory.length} records from localStorage`);
  return serviceHistory;
}

// Save service history to Firebase or localStorage
async function saveServiceHistory() {
  if (currentUserId) {
    try {
      // Save to Firebase - this is handled individually per record
      console.log('Service history synced to Firebase');
    } catch (error) {
      console.error('Error saving to Firebase:', error);
      // Fallback to localStorage
      localStorage.setItem('vehicleServiceHistory', JSON.stringify(serviceHistory));
    }
  } else {
    // Save to localStorage when not signed in
    localStorage.setItem('vehicleServiceHistory', JSON.stringify(serviceHistory));
  }
}

// --- Function to save individual service record ---
async function saveServiceRecord(serviceRecord) {
  if (!currentUserId) {
    // Save to localStorage when not signed in
    serviceHistory.push(serviceRecord);
    localStorage.setItem('vehicleServiceHistory', JSON.stringify(serviceHistory));
    showSuccessMessage('Service record saved locally!');
    return serviceRecord;
  }

  try {
    // Save to Firebase Firestore
    const docRef = await db.collection('users').doc(currentUserId).collection('serviceHistory').add(serviceRecord);
    serviceRecord.id = docRef.id;
    serviceHistory.push(serviceRecord);
    
    // Also save to localStorage as backup
    localStorage.setItem('vehicleServiceHistory', JSON.stringify(serviceHistory));
    
    showSuccessMessage('Service record saved to Firebase!');
    console.log(`Service record saved for user: ${currentUserId}`);
    return serviceRecord;
  } catch (error) {
    console.error('Firestore Save Failed:', error);
    // Fallback to localStorage
    serviceHistory.push(serviceRecord);
    localStorage.setItem('vehicleServiceHistory', JSON.stringify(serviceHistory));
    showErrorMessage('Failed to save to Firebase. Saved locally instead.');
    return serviceRecord;
  }
}

function logService(event) {
  event.preventDefault();
  
  const item = document.getElementById('serviceItem').value;
  const odometerValue = document.getElementById('serviceOdometer').value;
  const date = document.getElementById('serviceDate').value;
  const costValue = document.getElementById('serviceCost').value;
  const notes = document.getElementById('serviceNotes').value;
  
  // Validate required fields
  if (!item || !odometerValue || !date) {
    showErrorMessage('Please fill in all required fields (Service Item, Odometer, Date)');
    return;
  }
  
  const odometer = parseInt(odometerValue);
  const cost = parseFloat(costValue) || 0;
  
  // Validate odometer reading
  if (isNaN(odometer) || odometer <= 0) {
    showErrorMessage('Please enter a valid odometer reading');
    return;
  }
  
  const serviceRecord = {
    id: Date.now() + Math.random(), // Ensure unique ID
    item,
    odometer,
    date,
    cost,
    notes: notes.trim(),
    timestamp: new Date().toISOString()
  };
  
  try {
    // Save the service record
    saveServiceRecord(serviceRecord);
    
    // Clear form after successful save
    clearForm();
    
    // Refresh current view if needed
    if (currentTab === 'history') {
      renderHistory();
    }
    
  } catch (error) {
    console.error('Error in logService:', error);
    showErrorMessage('Failed to save service record. Please try again.');
  }
}

function clearForm() {
  document.getElementById('serviceForm').reset();
  document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
}

function populateServiceItems() {
  const select = document.getElementById('serviceItem');
  select.innerHTML = '<option value="">Select maintenance item...</option>';
  
  maintenanceItems.forEach(item => {
    const option = document.createElement('option');
    option.value = item.item;
    option.textContent = item.item;
    select.appendChild(option);
  });
}

function renderHistory() {
  const historyList = document.getElementById('historyList');
  const historyEmpty = document.getElementById('historyEmpty');
  const totalServices = document.getElementById('totalServices');
  
  totalServices.textContent = serviceHistory.length;
  
  if (serviceHistory.length === 0) {
    historyEmpty.classList.remove('hidden');
    historyList.classList.add('hidden');
    return;
  }
  
  historyEmpty.classList.add('hidden');
  historyList.classList.remove('hidden');
  
  // Sort by date (newest first)
  const sortedHistory = [...serviceHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
  
  historyList.innerHTML = '';
  
  sortedHistory.forEach(service => {
    const serviceCard = document.createElement('div');
    serviceCard.className = 'bg-gray-50 rounded-lg p-6 border-l-4 border-blue-500';
    
    const categoryIcon = getCategoryIcon(maintenanceItems.find(item => item.item === service.item)?.category || 'general');
    const costDisplay = service.cost > 0 ? `<span class="text-green-600 font-semibold">$${service.cost.toFixed(2)}</span>` : '<span class="text-gray-400">No cost recorded</span>';
    
    serviceCard.innerHTML = `
      <div class="flex justify-between items-start mb-3">
        <div class="flex items-center">
          <span class="text-2xl mr-3">${categoryIcon}</span>
          <div>
            <h3 class="font-bold text-gray-800">${service.item}</h3>
            <p class="text-sm text-gray-600">${new Date(service.date).toLocaleDateString()}</p>
          </div>
        </div>
        <div class="text-right">
          <p class="font-mono text-lg font-semibold text-gray-800">${service.odometer.toLocaleString()} km</p>
          <p class="text-sm">${costDisplay}</p>
        </div>
      </div>
      ${service.notes ? `<div class="bg-white rounded p-3 text-sm text-gray-700"><strong>Notes:</strong> ${service.notes}</div>` : ''}
      <div class="flex justify-end mt-3">
        <button onclick="deleteService(${service.id})" class="text-red-500 hover:text-red-700 text-sm font-medium">
          üóëÔ∏è Delete Record
        </button>
      </div>
    `;
    
    historyList.appendChild(serviceCard);
  });
}

// --- Function to delete service record from Firebase and local storage ---
async function deleteService(serviceId) {
  if (!confirm('Are you sure you want to delete this service record?')) {
    return;
  }
  
  try {
    if (currentUserId) {
      // Delete from Firebase Firestore
      await db.collection('users').doc(currentUserId).collection('serviceHistory').doc(serviceId).delete();
      console.log(`Service record deleted from Firebase for user: ${currentUserId}`);
      showSuccessMessage('Service record deleted from Firebase!');
    } else {
      showSuccessMessage('Service record deleted locally!');
    }
    
    // Remove from local array
    serviceHistory = serviceHistory.filter(service => service.id !== serviceId);
    
    // Update localStorage as backup
    localStorage.setItem('vehicleServiceHistory', JSON.stringify(serviceHistory));
    
    renderHistory();
  } catch (error) {
    console.error('Firestore Delete Failed:', error);
    showErrorMessage('Failed to delete service record from Firebase. Removed locally.');
    
    // Still remove from local array as fallback
    serviceHistory = serviceHistory.filter(service => service.id !== serviceId);
    localStorage.setItem('vehicleServiceHistory', JSON.stringify(serviceHistory));
    renderHistory();
  }
}

function getCategoryIcon(category) {
  const icons = {
    "engine": "üîß",
    "brake": "üõë",
    "electrical": "‚ö°",
    "fuel": "‚õΩ",
    "transmission": "‚öôÔ∏è",
    "cooling": "‚ùÑÔ∏è",
    "chassis": "üöó",
    "steering": "üéØ",
    "general": "üî©"
  };
  return icons[category] || "üîß";
}

function checkMaintenance() {
  const odo = parseInt(document.getElementById("odo").value);
  
  if (!odo || odo <= 0) {
    alert("Please enter a valid odometer reading");
    return;
  }

  maintenanceData = [];
  let criticalCount = 0;
  let soonCount = 0;
  let goodCount = 0;
  let preDriveCount = 0;

  maintenanceItems.forEach(item => {
    const lastServiceKm = getLastServiceKm(item.item);
    const nextDue = item.interval === 0 ? 0 : lastServiceKm + item.interval;
    const kmUntilDue = item.interval === 0 ? 0 : nextDue - odo;
    const statusInfo = getMaintenanceStatus(odo, item.interval, lastServiceKm);
    
    const itemData = {
      ...item,
      nextDue,
      kmUntilDue,
      statusInfo,
      lastServiceKm,
      lastServiceDate: getLastServiceDate(item.item)
    };
    
    maintenanceData.push(itemData);
    
    // Count items by status
    if (statusInfo.status === 'critical') criticalCount++;
    else if (statusInfo.status === 'soon') soonCount++;
    else if (statusInfo.status === 'good') goodCount++;
    else if (statusInfo.status === 'predrive') preDriveCount++;
  });

  // Sort by priority (critical first, then by km until due)
  maintenanceData.sort((a, b) => {
    if (a.statusInfo.priority !== b.statusInfo.priority) {
      return a.statusInfo.priority - b.statusInfo.priority;
    }
    if (a.interval === 0 && b.interval === 0) return 0;
    if (a.interval === 0) return 1;
    if (b.interval === 0) return -1;
    return a.kmUntilDue - b.kmUntilDue;
  });

  // Update summary cards
  document.getElementById("criticalCount").textContent = criticalCount;
  document.getElementById("soonCount").textContent = soonCount;
  document.getElementById("goodCount").textContent = goodCount;
  document.getElementById("preDriveCount").textContent = preDriveCount;

  // Show results
  document.getElementById("summaryDashboard").classList.remove("hidden");
  document.getElementById("navigationTabs").classList.remove("hidden");
  document.getElementById("filterTabs").classList.remove("hidden");
  document.getElementById("maintenanceCard").classList.remove("hidden");
  document.getElementById("welcomeState").classList.add("hidden");

  renderTable();
}

function getLastServiceDate(itemName) {
  const services = serviceHistory.filter(service => service.item === itemName);
  if (services.length === 0) return null;
  const latestService = services.reduce((latest, service) => 
    new Date(service.date) > new Date(latest.date) ? service : latest
  );
  return latestService.date;
}

function renderTable() {
  const tbody = document.getElementById("maintenanceTableBody");
  tbody.innerHTML = "";

  const filteredData = currentFilter === 'all' ? maintenanceData : 
                      maintenanceData.filter(item => item.statusInfo.status === currentFilter);

  filteredData.forEach(item => {
    const row = document.createElement("tr");
    row.className = "hover:bg-gray-50 transition-colors duration-150";

    const nextDueDisplay = item.interval === 0 ? 
      '<span class="text-blue-600 font-semibold">Every Drive</span>' :
      `<span class="font-mono text-gray-900">${item.nextDue.toLocaleString()}</span>
       <div class="text-sm text-gray-500">${item.kmUntilDue > 0 ? `in ${item.kmUntilDue.toLocaleString()} km` : 'overdue'}</div>`;

    const lastServiceDisplay = item.lastServiceKm > 0 ? 
      `<div class="text-xs text-green-600 mt-1">Last: ${item.lastServiceKm.toLocaleString()} km</div>` : 
      '<div class="text-xs text-gray-400 mt-1">Never serviced</div>';

    row.innerHTML = `
      <td class="px-6 py-4">
        <div class="flex items-center">
          <span class="text-2xl mr-3">${getCategoryIcon(item.category)}</span>
          <div>
            <span class="font-semibold text-gray-900">${item.item}</span>
            <div class="text-sm text-gray-500 capitalize">${item.category}</div>
            ${lastServiceDisplay}
          </div>
        </div>
      </td>
      <td class="px-6 py-4">
        <span class="font-medium text-gray-700">${item.action}</span>
      </td>
      <td class="px-6 py-4 text-center">
        <span class="font-mono text-gray-600">
          ${item.interval === 0 ? 'Pre-Drive' : item.interval.toLocaleString() + ' km'}
        </span>
      </td>
      <td class="px-6 py-4 text-center">
        ${nextDueDisplay}
      </td>
      <td class="px-6 py-4 text-center">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${item.statusInfo.class}">
          ${item.statusInfo.label}
        </span>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function filterItems(filter) {
  currentFilter = filter;
  
  // Update active button
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active', 'bg-blue-600', 'text-white');
    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
  });
  
  event.target.classList.add('active', 'bg-blue-600', 'text-white');
  event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
  
  renderTable();
}

// UI Feedback Functions
function showSuccessMessage(message) {
  showToast(message, 'success');
}

function showErrorMessage(message) {
  showToast(message, 'error');
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-full`;
  
  if (type === 'success') {
    toast.classList.add('bg-green-600');
    toast.innerHTML = `<div class="flex items-center"><span class="mr-2">‚úÖ</span>${message}</div>`;
  } else if (type === 'error') {
    toast.classList.add('bg-red-600');
    toast.innerHTML = `<div class="flex items-center"><span class="mr-2">‚ùå</span>${message}</div>`;
  } else {
    toast.classList.add('bg-blue-600');
    toast.innerHTML = `<div class="flex items-center"><span class="mr-2">‚ÑπÔ∏è</span>${message}</div>`;
  }
  
  document.body.appendChild(toast);
  
  // Animate in
  setTimeout(() => {
    toast.classList.remove('translate-x-full');
  }, 100);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    toast.classList.add('translate-x-full');
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 4000);
}

// Initialize form and event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Load service history (Firebase will handle this via auth state change)
  // loadServiceHistory() is called automatically when auth state changes
  
  // Set default date to today
  document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
  
  // Add form submission handler
  document.getElementById('serviceForm').addEventListener('submit', logService);
  
  // Initialize navigation tab styles
  const activeTab = document.querySelector('.nav-tab.active');
  if (activeTab) {
    activeTab.classList.add('bg-blue-600', 'text-white');
    activeTab.classList.remove('text-gray-600', 'hover:bg-gray-100');
  }
  
  document.querySelectorAll('.nav-tab:not(.active)').forEach(btn => {
    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
  });
  
  // Initialize filter button styles
  const activeFilter = document.querySelector('.filter-btn.active');
  if (activeFilter) {
    activeFilter.classList.add('bg-blue-600', 'text-white');
    activeFilter.classList.remove('text-gray-600', 'hover:bg-gray-100');
  }
  
  document.querySelectorAll('.filter-btn:not(.active)').forEach(btn => {
    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
  });
});

// Allow Enter key to trigger check
document.getElementById("odo").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    checkMaintenance();
  }
});
</script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98b40179e301db1c',t:'MTc1OTkwOTM5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
